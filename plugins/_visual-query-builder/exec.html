<!-- visual_query_builder -->
<div id="visual_query_builder">

    <ul id="ntabs0" class="ntabs">
        <li class="selected">Query Designer</li>
        <li>Results</li>
    </ul>


    <!-- model -->
    <div id="ntabs0_content" class="ntabs_content">

        <!-- tables_wrapper -->
        <div id="tables_wrapper">

            <!-- tables -->
            <div id="tables">

                <!-- tables_search -->
                <div id="table_search">
                    <input type="text" id="table_search_input" placeholder="{$nuts_lang_msg[11]}" />
                </div>
                <!-- /tables_search -->

                <ul>

                    <bloc::tables>
                    <li class="{table_type}" ac="{table_name_lower}">{table_name}</li>
                    </bloc::tables>

                </ul>

            </div>
            <!-- /tables -->


            <!-- right_view -->
            <div id="right_view">

                <!-- sql_btns -->
                <div id="sql_btns">
                    <button>SELECT</button>
                    <button>JOIN</button>
                    <button>WHERE</button>
                    <button>GROUP BY</button>
                    <button>HAVING</button>
                    <button>ORDER BY</button>
                </div>
                <!-- /sql_btns -->


                <!-- canvas -->
                <div id="canvas">

                </div>
                <!-- /canvas -->

                <!-- sql_code -->
                <textarea id="SqlCode" class="editor" wrap="off"></textarea>
                <!-- /sql_code -->

            </div>
            <!-- /right_view -->

        </div>
        <!-- /tables_wrapper -->

        <div class="clearfix"></div>

    </div>
    <!-- /model -->




</div>
<!-- /visual_query_builder -->

<script type="text/javascript">
$(document).ready(function(){

    nTabInit('ntabs0');


    // autocomplete
    $('#table_search_input').keyup(function(){

        if($(this).val() == '')
        {
            $("#tables li").show();
            return;
        }

        $("#tables li").each(function(){

            txt = strtolower($(this).text());
            v = strtolower($('#table_search_input').val());
            if(txt.indexOf(v) == -1)
                $(this).hide();
            else
                $(this).show();

        });

    });


    // buttons
    $('#sql_btns button').each(function(){

        $(this).click(function(){

            if($(this).hasClass('selected'))
            {
                $(this).removeClass('selected');
            }
            else
            {
                $('#sql_btns button').removeClass('selected');
                $(this).addClass('selected');
            }

        });

    });


    // init from parent
    if("{$_GET['parent']}" != '')
    {
        parent_v = window.opener.$('#{$_GET['parent']}').val();
        parent_v = queryFormatCode(parent_v);
        $('#SqlCode').val(parent_v);
    }


    $('#SqlCode').tabby();


    $(window).bind('resize', function(){

        nw = $('#tables_wrapper').width() - $('#tables').width() - 35;
        if(nw < 755)nw = 755;

        $('#right_view').width(nw+5);
        $('#canvas').width(nw);
        $('#SqlCode').width(nw-10);
    });

    $(window).resize();


})

function queryFormatCode(sql)
{
    // in ajax
    $('#SqlCode').val("Loading...");

    uri = '?mod=_visual-query-builder&do=exec&ajaxer=1&action=format_sql'
    $.post(uri, {sql:sql}, function(resp){
        $('#SqlCode').val(resp);
    });
}

</script>